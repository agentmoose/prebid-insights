# prebid-integration-monitor

This project is designed to monitor Prebid integrations. It is now built using TypeScript and uses Vitest for testing.

## Prerequisites

- Node.js (v16 or later recommended)
- npm (comes with Node.js)

## Setup

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/prebid/prebid-integration-monitor.git
    cd prebid-integration-monitor
    ```

2.  **Install dependencies:**
    ```bash
    npm install
    ```

## Project Structure

-   `bin/`: Contains executable scripts for running the CLI.
    -   `dev.js`: Entry point for development mode (uses ts-node).
    -   `run.js`: Entry point for production mode (uses compiled JS).
-   `src/`: Contains the TypeScript source code for the application.
    -   `commands/`: Contains the oclif command classes.
        -   `scan.ts`: Handles the primary scanning logic.
    -   `utils/`: Utility scripts.
        -   `logger.ts`: Configures the Winston logger.
        -   `puppeteerTaskRunner.ts`: Manages Puppeteer browser instances and page processing tasks.
        -   `resultsProcessor.ts`: Handles processing and saving of scan results.
        -   `urlProcessor.ts`: Responsible for fetching and processing URLs from various sources.
    -   `prebid.ts`: Core module orchestrating the scan logic, called by commands.
    -   `index.ts`: Main entry point for oclif, used to export commands.
    -   `tracer.ts`: OpenTelemetry tracer configuration.
-   `dist/`: Contains the compiled JavaScript code, generated by `npm run build`.
-   `docs/`: Contains API documentation generated by TypeDoc.
-   `logs/`: Contains log files generated during application runtime (e.g., `app.log`, `error.log`).
-   `store/`: Default directory for storing scan results (JSON files).
-   `tests/`: Contains test files written using Vitest.
-   `package.json`: Lists project dependencies, npm scripts, and oclif configuration.
-   `typedoc.json`: Configuration file for TypeDoc documentation generation.
-   `tsconfig.json`: Configuration file for the TypeScript compiler.
-   `node_modules/`: Directory where npm installs project dependencies.


## API Documentation (TypeDoc)

This project uses [TypeDoc](https://typedoc.org/) to generate API documentation from the TypeScript source code comments.

To generate the documentation:
```bash
npm run docs
```
This will create (or update) the `docs/` directory in the project root. You can then open the `docs/index.html` file in your web browser to view the documentation.

## Development

To run the application in development mode (using the oclif development script, which leverages `ts-node`):

```bash
npm run dev scan -- --githubRepo https://github.com/prebid/prebid-integration-examples
```
This executes `node ./bin/dev.js scan ...` which handles TypeScript execution.

## Building for Production

To compile the TypeScript code to JavaScript (output will be in the `dist/` directory):

```bash
npm run build
```

**Note on `tsc` execution:** In some environments, if `tsc` (the TypeScript compiler) is not found via the npm script, you might need to invoke it using `npx`:
```bash
npx -p typescript tsc
```
This command typically isn't needed if `npm run build` works, as `npm run build` should use the `tsc` from your project's `devDependencies`. The type checking can also be done using `npm run build:check`.

## Running in Production

After building the project (`npm run build`), run the compiled application using its oclif entry point:

```bash
npm start -- scan --githubRepo https://github.com/prebid/prebid-integration-examples
# Or directly:
# node ./bin/run.js scan --githubRepo https://github.com/prebid/prebid-integration-examples
```

## CLI Usage (oclif)

This application is structured as an oclif (Open CLI Framework) command-line interface.

-   **Running commands:**
    -   In development: `node ./bin/dev.js [COMMAND] [FLAGS]`
    -   In production (after `npm run build`): `node ./bin/run.js [COMMAND] [FLAGS]`
    -   If the package is linked globally (`npm link`) or installed globally, you can use the bin name directly: `app [COMMAND] [FLAGS]` (Note: `app` is the default bin name configured in `package.json`).


-   **Getting Help:**
    -   To see general help for the CLI and a list of available commands:
        ```bash
        node ./bin/run.js --help
        ```
        or in development:
        ```bash
        node ./bin/dev.js --help
        ```
    -   For help on a specific command:
        ```bash
        node ./bin/run.js [COMMAND] --help
        ```

### `scan` Command

The `scan` command is used to analyze a list of websites for Prebid.js integrations and other specified ad technology libraries. It processes URLs from an input file or GitHub repository, launches Puppeteer instances to visit these pages, and collects data, saving the results to an output directory.

**Syntax:**

```bash
./bin/run scan [INPUTFILE] [FLAGS...]
# or in development: node ./bin/dev.js scan [INPUTFILE] [FLAGS...]
# or using npm script: npm run prebid:scan -- [INPUTFILE] [FLAGS...] (note the -- to pass arguments to the script)
```

**Argument:**

-   `INPUTFILE`: (Optional) Path to a local input file containing URLs.
    -   Accepts `.txt` (one URL per line), `.csv` (URLs in the first column), or `.json` (extracts all string values that are URLs) files.
    -   This argument is required if `--githubRepo` is not used.
    -   If `--githubRepo` is provided, `INPUTFILE` is ignored (unless it's the default and no explicit `INPUTFILE` is given).
    -   Defaults to `src/input.txt` if no other source is specified.

**Flags:**

-   `--githubRepo <URL>`: Specifies a public GitHub URL from which to fetch URLs.
    -   This can be a base repository URL (e.g., `https://github.com/owner/repo`) to scan for URLs within processable files (like `.txt`, `.json`, `.md`, `.csv`) in the repository root.
    -   Alternatively, it can be a direct link to a specific processable file within a repository (e.g., `https://github.com/owner/repo/blob/main/some/path/file.txt`). In this case, only the specified file will be fetched and processed.
-   `--numUrls <number>`: When used with `--githubRepo`, this flag limits the number of URLs to be extracted and processed from the repository.
    -   Default: `100`
-   `--puppeteerType <option>`: Specifies the Puppeteer operational mode.
    -   Options: `vanilla`, `cluster` (default)
    -   `vanilla`: Processes URLs sequentially using a single Puppeteer browser instance.
    -   `cluster`: Uses `puppeteer-cluster` to process URLs in parallel, according to the concurrency settings.
-   `--concurrency <value>`: Sets the number of concurrent Puppeteer instances when using `puppeteerType=cluster`.
    -   Default: `5`
-   `--headless` / `--no-headless`: Runs Puppeteer in headless mode (no UI) by default. Use `--no-headless` to run with a visible browser UI.
-   `--monitor`: Enables `puppeteer-cluster`'s web monitoring interface (available at `http://localhost:21337` by default) when `puppeteerType=cluster`.
    -   Default: `false`
-   `--outputDir <value>`: Specifies the directory where scan results (JSON files) will be saved.
    -   Default: `store`
    -   Results are typically saved in a subdirectory structure like `store/Month/YYYY-MM-DD.json`.
-   `--logDir <value>`: Specifies the directory where log files (`app.log`, `error.log`) will be saved.
    -   Default: `logs`
-   `--range <string>`: Specify a 1-based line range (e.g., '10-20', '5-', '-15') to process from the input URL list. Applies after URLs are fetched.
-   `--chunkSize <number>`: Process URLs in chunks of this size. Processes all URLs in the specified range or input, but one chunk at a time. '0' means no chunking.

**Usage Examples:**

1.  **Basic scan (using default `input.txt` and cluster mode):**
    ```bash
    ./bin/run scan
    ```
    *(Ensure `./bin/run` has execute permissions or use `node ./bin/run scan`)*

2.  **Scan using vanilla Puppeteer:**
    ```bash
    ./bin/run scan --puppeteerType=vanilla
    ```

3.  **Scan with a specific input file and output directory:**
    ```bash
    ./bin/run scan my_urls.txt --outputDir=./my_results
    ```

4.  **Scan URLs from a GitHub repository:**
    ```bash
    ./bin/run scan --githubRepo https://github.com/owner/repo
    ```

#### Notes on URL Extraction
-   When processing `.txt` or `.md` files, the scanner looks for fully qualified URLs and also attempts to identify and prepend `https://` to schemeless domains (e.g., `example.com` becomes `https://example.com`).
-   For `.csv` files, URLs are expected to be in the first column and should be fully qualified.
-   For `.json` files, all string values are recursively scanned for fully qualified URLs.
-   Malformed URLs or unsupported schemes are generally skipped.

### `stats:generate` Command

The `stats:generate` command processes stored website scan data (typically found in the `./store` directory, generated by the `scan` command) to generate or update the `api/api.json` file. This JSON file contains aggregated statistics about Prebid.js usage.

**Syntax:**

```bash
./bin/run stats:generate
# or in development: node ./bin/dev.js stats:generate
```

## Running Tests

To run the test suite using Vitest:

```bash
npm test
```

## Logging

This application utilizes Winston for structured logging.

### Log Files
-   **`logs/app.log`**: General application logs (info level and above) in JSON format.
-   **`logs/error.log`**: Error-level logs only, in JSON format.

### Console Output
-   Colorized, formatted logs (info level and above).

## OpenTelemetry Integration
-   Configured in `src/tracer.ts`.
-   Logs are enriched with `trace_id` and `span_id`.
-   Set `OTEL_EXPORTER_OTLP_ENDPOINT` (e.g., `http://localhost:4318/v1/traces`) and `OTEL_SERVICE_NAME` for your OpenTelemetry collector.
